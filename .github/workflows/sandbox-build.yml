name: Sandbox Build

on:
  push:
    branches: [main]
    paths: ['sandbox/**']

env:
  REGISTRY: ghcr.io

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed-distros: ${{ steps.detect.outputs.changed-distros }}
      configs-to-build: ${{ steps.detect.outputs.configs-to-build }}
      has-distro-changes: ${{ steps.detect.outputs.has-distro-changes }}
      has-config-builds: ${{ steps.detect.outputs.has-config-builds }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes and compute dependencies
        id: detect
        run: |
          set -ex

          # 1. Detect changed distros
          CHANGED_DISTROS=$(git diff --name-only HEAD~1...HEAD -- sandbox/vm/distro/ | \
            sed -n 's|sandbox/vm/distro/\([^/]*\)/.*|\1|p' | sort -u | tr '\n' ' ')

          # 2. Detect directly changed configs
          CHANGED_CONFIGS=$(git diff --name-only HEAD~1...HEAD -- sandbox/vm/kubernetes/ | \
            sed -n 's|sandbox/vm/kubernetes/\([^/]*\)/.*|\1|p' | sort -u | tr '\n' ' ')

          # 3. If any distro changed, all configs need rebuilding
          DEPENDENT_CONFIGS=""
          if [ -n "$CHANGED_DISTROS" ]; then
            for config_dir in sandbox/vm/kubernetes/*/; do
              if [ -d "$config_dir" ]; then
                DEPENDENT_CONFIGS="$DEPENDENT_CONFIGS $(basename "$config_dir")"
              fi
            done
          fi

          # 4. Merge changed + dependent configs (dedupe)
          ALL_CONFIGS=$(echo "$CHANGED_CONFIGS $DEPENDENT_CONFIGS" | tr ' ' '\n' | sort -u | grep -v '^$' | tr '\n' ' ')

          # Output as JSON arrays
          echo "changed-distros=$(echo $CHANGED_DISTROS | jq -R -c 'split(" ") | map(select(. != ""))')" >> $GITHUB_OUTPUT
          echo "configs-to-build=$(echo $ALL_CONFIGS | jq -R -c 'split(" ") | map(select(. != ""))')" >> $GITHUB_OUTPUT
          echo "has-distro-changes=$([ -n "$CHANGED_DISTROS" ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has-config-builds=$([ -n "$ALL_CONFIGS" ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

  build-distros:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-distro-changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      packages: write
    strategy:
      matrix:
        distro: ${{ fromJson(needs.detect-changes.outputs.changed-distros) }}
    steps:
      - uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup build environment
        uses: ./.github/actions/setup-sandbox-build
        with:
          sandbox-cli-token: ${{ secrets.SANDBOX_CLI_TOKEN }}

      - name: Build and publish distro
        run: |
          set -ex
          DISTRO_PATH="sandbox/vm/distro/${{ matrix.distro }}"
          TIMESTAMP=$(date -u +%Y%m%dT%H%M)

          # Read metadata
          DISTRO_VERSION=$(yq '.settings.distro_version[0]' "$DISTRO_PATH/metadata.yaml")

          # Build
          sandbox build "$DISTRO_PATH"

          # Publish with tags: :distro_version, :latest, :distro_version-timestamp
          sandbox publish "$DISTRO_PATH" --version "$DISTRO_VERSION"
          sandbox publish "$DISTRO_PATH" --version "latest"
          sandbox publish "$DISTRO_PATH" --version "${DISTRO_VERSION}-${TIMESTAMP}"

  build-kubernetes:
    needs: [detect-changes, build-distros]
    if: always() && needs.detect-changes.outputs.has-config-builds == 'true' && (needs.build-distros.result == 'success' || needs.build-distros.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      packages: write
    strategy:
      matrix:
        config: ${{ fromJson(needs.detect-changes.outputs.configs-to-build) }}
    steps:
      - uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup build environment
        uses: ./.github/actions/setup-sandbox-build
        with:
          sandbox-cli-token: ${{ secrets.SANDBOX_CLI_TOKEN }}

      - name: Build all distro variants
        run: |
          set -ex
          CONFIG_PATH="sandbox/vm/kubernetes/${{ matrix.config }}"
          TIMESTAMP=$(date -u +%Y%m%dT%H%M)

          # Read config metadata
          K8S_VERSION=$(yq '.settings.k8s_version[0]' "$CONFIG_PATH/metadata.yaml")
          DEFAULT_DISTRO=$(yq '.settings.distro[0]' "$CONFIG_PATH/metadata.yaml")

          # Build a variant for every distro
          for distro_dir in sandbox/vm/distro/*/; do
            distro_name=$(basename "$distro_dir")
            distro_version=$(yq '.settings.distro_version[0]' "$distro_dir/metadata.yaml")

            echo "Building ${{ matrix.config }} for $distro_name ($distro_version)"

            # Build with env var overrides
            SANDBOX_SETTING_DISTRO="$distro_name" \
            SANDBOX_SETTING_K8S_VERSION="$K8S_VERSION" \
              sandbox build "$CONFIG_PATH"

            # Publish with variant-specific tags
            # Always: :distro_version, :k8s-distro_version, :k8s-distro_version-timestamp
            SANDBOX_SETTING_DISTRO="$distro_name" \
              sandbox publish "$CONFIG_PATH" --version "$distro_version"
            SANDBOX_SETTING_DISTRO="$distro_name" \
              sandbox publish "$CONFIG_PATH" --version "${K8S_VERSION}-${distro_version}"
            SANDBOX_SETTING_DISTRO="$distro_name" \
              sandbox publish "$CONFIG_PATH" --version "${K8S_VERSION}-${distro_version}-${TIMESTAMP}"

            # If default distro, also publish :k8s and :latest
            if [ "$distro_name" == "$DEFAULT_DISTRO" ]; then
              SANDBOX_SETTING_DISTRO="$distro_name" \
                sandbox publish "$CONFIG_PATH" --version "$K8S_VERSION"
              SANDBOX_SETTING_DISTRO="$distro_name" \
                sandbox publish "$CONFIG_PATH" --version "latest"
            fi
          done
