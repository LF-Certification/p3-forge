name: Update alpine containerdisk

on:
  schedule:
    - cron: '0 6 * * 1'
  workflow_dispatch:

jobs:
  check-alpine-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for Alpine updates
        id: check
        run: |
          set -e
          DOCKERFILE="images/alpine-containerdisk/Dockerfile"
          CURRENT=$(grep -oP 'ARG ALPINE_VERSION=\K[0-9.]+' "$DOCKERFILE")
          CURRENT_MINOR="${CURRENT%.*}"

          BASE_URL="https://dl-cdn.alpinelinux.org/alpine/v${CURRENT_MINOR}/releases/cloud"
          LATEST=$(curl -sf "$BASE_URL/" | \
            grep -oE 'nocloud_alpine-[0-9.]+-x86_64-bios-tiny-r[0-9]+\.qcow2' | \
            sed 's/nocloud_alpine-\([0-9.]*\)-.*/\1/' | \
            sort -V | tail -1)

          if [ -z "$LATEST" ]; then
            echo "::error::Failed to parse latest Alpine version from $BASE_URL"
            exit 1
          fi

          echo "current=$CURRENT" >> "$GITHUB_OUTPUT"
          echo "latest=$LATEST" >> "$GITHUB_OUTPUT"

          if [ "$CURRENT" != "$LATEST" ]; then
            echo "update_available=true" >> "$GITHUB_OUTPUT"
          else
            echo "update_available=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Update Dockerfile and tag
        if: steps.check.outputs.update_available == 'true'
        run: |
          set -e
          DOCKERFILE="images/alpine-containerdisk/Dockerfile"
          CURRENT="${{ steps.check.outputs.current }}"
          LATEST="${{ steps.check.outputs.latest }}"
          TAG="alpine-containerdisk-v${LATEST}"

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "::notice::Tag $TAG already exists, skipping update"
            exit 0
          fi

          sed -i "s/ARG ALPINE_VERSION=${CURRENT}/ARG ALPINE_VERSION=${LATEST}/" "$DOCKERFILE"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$DOCKERFILE"
          git commit -m "feat(alpine-containerdisk): update to Alpine ${LATEST}"
          git tag "$TAG"
          git push origin main "$TAG"

      - name: Output summary
        run: |
          echo "## Alpine Version Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Current version:** \`${{ steps.check.outputs.current }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Latest version:** \`${{ steps.check.outputs.latest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.update_available }}" = "true" ]; then
            echo "Updated and tagged \`alpine-containerdisk-v${{ steps.check.outputs.latest }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "Already up to date." >> $GITHUB_STEP_SUMMARY
          fi
