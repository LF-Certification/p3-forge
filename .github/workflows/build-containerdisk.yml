# Build Ubuntu 24.04 ContainerDisk using Makefile
name: Build Ubuntu 24.04 ContainerDisk
on:
  push:
    branches: [ main ]
    paths:
      - 'images/ubuntu-2404-containerdisk/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'images/ubuntu-2404-containerdisk/**'
  workflow_dispatch:
    inputs:
      registry:
        description: 'Container registry to push to'
        required: false
        default: 'ghcr.io'
      image_tag:
        description: 'Image tag to use'
        required: false
        default: 'latest'
env:
  REGISTRY: ${{ github.event.inputs.registry || 'ghcr.io' }}
  IMAGE_NAME: ${{ github.repository_owner }}/ubuntu-2404-containerdisk
  IMAGE_TAG: ${{ github.event.inputs.image_tag || github.sha }}
  BASE_IMAGE: quay.io/containerdisks/ubuntu:24.04
  WORK_DIR: build-workspace
jobs:
  build-containerdisk:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      packages: write
      id-token: write
      actions: read
    outputs:
      image-url: ${{ steps.build.outputs.image-url }}
      image-tag: ${{ env.IMAGE_TAG }}
      registry: ${{ env.REGISTRY }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for proper git info

    - name: Setup caching
      uses: actions/cache@v4
      with:
        path: ~/.cache/podman-images
        key: base-image-${{ env.BASE_IMAGE }}-${{ hashFiles('images/ubuntu-2404-containerdisk/overlay-initramfs-script.sh') }}
        restore-keys: |
          base-image-${{ env.BASE_IMAGE }}-

    - name: Validate inputs and setup environment
      working-directory: images/ubuntu-2404-containerdisk
      run: |
        # Export environment variables for Makefile
        export REGISTRY="${{ env.REGISTRY }}"
        export IMAGE_NAME="${{ env.IMAGE_NAME }}"
        export IMAGE_TAG="${{ env.IMAGE_TAG }}"
        export BASE_IMAGE="${{ env.BASE_IMAGE }}"
        export WORK_DIR="${{ env.WORK_DIR }}"
        export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
        export GITHUB_ACTOR="${{ github.actor }}"
        export GITHUB_REPOSITORY="${{ github.repository }}"
        export GITHUB_REF="${{ github.ref }}"
        export GITHUB_REF_NAME="${{ github.ref_name }}"
        export GITHUB_SHA="${{ github.sha }}"
        export GITHUB_RUN_ID="${{ github.run_id }}"
        export GITHUB_EVENT_NAME="${{ github.event_name }}"
        export GITHUB_OUTPUT="${{ github.output }}"
        export RUNNER_OS="${{ runner.os }}"

        # Run validation and setup
        make validate-inputs setup-environment

    - name: Extract and modify base image
      working-directory: images/ubuntu-2404-containerdisk
      run: |
        # Export environment variables for Makefile
        export REGISTRY="${{ env.REGISTRY }}"
        export IMAGE_NAME="${{ env.IMAGE_NAME }}"
        export IMAGE_TAG="${{ env.IMAGE_TAG }}"
        export BASE_IMAGE="${{ env.BASE_IMAGE }}"
        export WORK_DIR="${{ env.WORK_DIR }}"
        export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
        export GITHUB_ACTOR="${{ github.actor }}"
        export GITHUB_REPOSITORY="${{ github.repository }}"
        export GITHUB_REF="${{ github.ref }}"
        export GITHUB_REF_NAME="${{ github.ref_name }}"
        export GITHUB_SHA="${{ github.sha }}"
        export GITHUB_RUN_ID="${{ github.run_id }}"
        export GITHUB_EVENT_NAME="${{ github.event_name }}"
        export GITHUB_OUTPUT="${{ github.output }}"
        export RUNNER_OS="${{ runner.os }}"

        # Extract base image and modify with overlay script
        make extract-base-image modify-disk-image

    - name: Build container image
      id: build
      working-directory: images/ubuntu-2404-containerdisk
      run: |
        # Export environment variables for Makefile
        export REGISTRY="${{ env.REGISTRY }}"
        export IMAGE_NAME="${{ env.IMAGE_NAME }}"
        export IMAGE_TAG="${{ env.IMAGE_TAG }}"
        export BASE_IMAGE="${{ env.BASE_IMAGE }}"
        export WORK_DIR="${{ env.WORK_DIR }}"
        export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
        export GITHUB_ACTOR="${{ github.actor }}"
        export GITHUB_REPOSITORY="${{ github.repository }}"
        export GITHUB_REF="${{ github.ref }}"
        export GITHUB_REF_NAME="${{ github.ref_name }}"
        export GITHUB_SHA="${{ github.sha }}"
        export GITHUB_RUN_ID="${{ github.run_id }}"
        export GITHUB_EVENT_NAME="${{ github.event_name }}"
        export GITHUB_OUTPUT="${{ github.output }}"
        export RUNNER_OS="${{ runner.os }}"

        # Build container image
        make build-container-image

        # Set output for downstream steps
        echo "image-url=${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}" >> $GITHUB_OUTPUT

    - name: Push container image
      working-directory: images/ubuntu-2404-containerdisk
      if: success()
      run: |
        # Export environment variables for Makefile
        export REGISTRY="${{ env.REGISTRY }}"
        export IMAGE_NAME="${{ env.IMAGE_NAME }}"
        export IMAGE_TAG="${{ env.IMAGE_TAG }}"
        export BASE_IMAGE="${{ env.BASE_IMAGE }}"
        export WORK_DIR="${{ env.WORK_DIR }}"
        export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
        export GITHUB_ACTOR="${{ github.actor }}"
        export GITHUB_REPOSITORY="${{ github.repository }}"
        export GITHUB_REF="${{ github.ref }}"
        export GITHUB_REF_NAME="${{ github.ref_name }}"
        export GITHUB_SHA="${{ github.sha }}"
        export GITHUB_RUN_ID="${{ github.run_id }}"
        export GITHUB_EVENT_NAME="${{ github.event_name }}"
        export GITHUB_OUTPUT="${{ github.output }}"
        export RUNNER_OS="${{ runner.os }}"

        # Registry-specific credentials
        export QUAY_USERNAME="${{ secrets.QUAY_USERNAME }}"
        export QUAY_PASSWORD="${{ secrets.QUAY_PASSWORD }}"
        export DOCKERHUB_USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"
        export DOCKERHUB_TOKEN="${{ secrets.DOCKERHUB_TOKEN }}"

        # Setup authentication and push
        make push

    - name: Validate and generate summary
      working-directory: images/ubuntu-2404-containerdisk
      if: success()
      run: |
        # Export environment variables for Makefile
        export REGISTRY="${{ env.REGISTRY }}"
        export IMAGE_NAME="${{ env.IMAGE_NAME }}"
        export IMAGE_TAG="${{ env.IMAGE_TAG }}"
        export BASE_IMAGE="${{ env.BASE_IMAGE }}"
        export WORK_DIR="${{ env.WORK_DIR }}"
        export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
        export GITHUB_ACTOR="${{ github.actor }}"
        export GITHUB_REPOSITORY="${{ github.repository }}"
        export GITHUB_REF="${{ github.ref }}"
        export GITHUB_REF_NAME="${{ github.ref_name }}"
        export GITHUB_SHA="${{ github.sha }}"
        export GITHUB_RUN_ID="${{ github.run_id }}"
        export GITHUB_EVENT_NAME="${{ github.event_name }}"
        export GITHUB_OUTPUT="${{ github.output }}"
        export RUNNER_OS="${{ runner.os }}"

        # Validate image and generate build summary
        make validate-image generate-summary

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-artifacts-${{ env.IMAGE_TAG }}
        path: |
          images/ubuntu-2404-containerdisk/build-summary.md
          images/ubuntu-2404-containerdisk/validation-results.txt
        retention-days: 30
