# Build Ubuntu 24.04 ContainerDisk using Makefile
name: Build Ubuntu 24.04 ContainerDisk
on:
  push:
    branches: [ main ]
    paths:
      - 'images/ubuntu-2404-containerdisk/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'images/ubuntu-2404-containerdisk/**'
  workflow_dispatch:
    inputs:
      registry:
        description: 'Container registry to push to'
        required: false
        default: 'ghcr.io'
      image_tag:
        description: 'Image tag to use'
        required: false
        default: 'latest'
env:
  REGISTRY: ${{ github.event.inputs.registry || 'ghcr.io' }}
  IMAGE_NAME: ${{ github.repository_owner }}/ubuntu-2404-containerdisk
  IMAGE_TAG: ${{ github.event.inputs.image_tag || github.sha }}
  WORK_DIR: build-workspace
jobs:
  build-containerdisk:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      packages: write
      id-token: write
      actions: read
    outputs:
      image-url: ${{ steps.build.outputs.image-url }}
      image-tag: ${{ env.IMAGE_TAG }}
      registry: ${{ env.REGISTRY }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for proper git info

    - name: Setup build environment variables
      run: |
        echo "REGISTRY=${{ env.REGISTRY }}" >> $GITHUB_ENV
        echo "IMAGE_NAME=${{ env.IMAGE_NAME }}" >> $GITHUB_ENV
        echo "IMAGE_TAG=${{ env.IMAGE_TAG }}" >> $GITHUB_ENV
        echo "WORK_DIR=${{ env.WORK_DIR }}" >> $GITHUB_ENV
        echo "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV
        echo "GITHUB_ACTOR=${{ github.actor }}" >> $GITHUB_ENV
        echo "GITHUB_REPOSITORY=${{ github.repository }}" >> $GITHUB_ENV
        echo "GITHUB_REF=${{ github.ref }}" >> $GITHUB_ENV
        echo "GITHUB_REF_NAME=${{ github.ref_name }}" >> $GITHUB_ENV
        echo "GITHUB_SHA=${{ github.sha }}" >> $GITHUB_ENV
        echo "GITHUB_RUN_ID=${{ github.run_id }}" >> $GITHUB_ENV
        echo "GITHUB_EVENT_NAME=${{ github.event_name }}" >> $GITHUB_ENV
        echo "GITHUB_OUTPUT=${{ github.output }}" >> $GITHUB_ENV
        echo "RUNNER_OS=${{ runner.os }}" >> $GITHUB_ENV

    - name: Setup caching
      uses: actions/cache@v4
      with:
        path: ~/.cache/podman-images
        key: ubuntu-2404-${{ hashFiles('images/ubuntu-2404-containerdisk/overlay-initramfs-script.sh') }}
        restore-keys: |
          ubuntu-2404-

    - name: Validate inputs and setup environment
      working-directory: images/ubuntu-2404-containerdisk
      run: make validate-inputs setup-environment

    - name: Extract and modify base image
      working-directory: images/ubuntu-2404-containerdisk
      run: make extract-base-image modify-disk-image

    - name: Build container image
      id: build
      working-directory: images/ubuntu-2404-containerdisk
      run: |
        make build-container-image
        echo "image-url=${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}" >> $GITHUB_OUTPUT

    - name: Push container image
      working-directory: images/ubuntu-2404-containerdisk
      if: success()
      env:
        QUAY_USERNAME: ${{ secrets.QUAY_USERNAME }}
        QUAY_PASSWORD: ${{ secrets.QUAY_PASSWORD }}
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      run: make push

    - name: Generate summary
      working-directory: images/ubuntu-2404-containerdisk
      if: success()
      run: make generate-summary

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-artifacts-${{ env.IMAGE_TAG }}
        path: |
          images/ubuntu-2404-containerdisk/build-summary.md
          images/ubuntu-2404-containerdisk/validation-results.txt
        retention-days: 30
